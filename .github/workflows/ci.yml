name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build & Test
    runs-on: macos-14
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Select Xcode
      run: |
        # List available Xcode versions and select the latest
        ls /Applications | grep Xcode
        sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode_15.3.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

    - name: Show Xcode Version
      run: xcodebuild -version

    - name: Show Available Simulators
      run: xcrun simctl list devices available | grep -E "iPhone 1[45]|iPhone 16"

    - name: Build for iOS Simulator
      run: |
        # Find an available iPhone simulator
        DESTINATION=$(xcrun simctl list devices available | grep "iPhone 15 Pro" | head -1 | sed 's/.*(\(.*\)).*/\1/' | head -1)
        if [ -z "$DESTINATION" ]; then
          DESTINATION="platform=iOS Simulator,name=iPhone 15 Pro"
        else
          DESTINATION="platform=iOS Simulator,id=$DESTINATION"
        fi
        echo "Using destination: $DESTINATION"
        
        xcodebuild build \
          -project VisualAssist.xcodeproj \
          -scheme VisualAssist \
          -destination "$DESTINATION" \
          -configuration Debug \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          SWIFT_STRICT_CONCURRENCY=minimal \
          | xcpretty && exit ${PIPESTATUS[0]}

    - name: Build for Release
      run: |
        xcodebuild build \
          -project VisualAssist.xcodeproj \
          -scheme VisualAssist \
          -destination 'generic/platform=iOS' \
          -configuration Release \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          SWIFT_STRICT_CONCURRENCY=minimal \
          | xcpretty && exit ${PIPESTATUS[0]}

  code-analysis:
    name: Code Analysis
    runs-on: macos-14
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install SwiftLint
      run: brew install swiftlint

    - name: Run SwiftLint
      run: swiftlint lint --reporter github-actions-logging
      continue-on-error: true
      
    - name: Check for TODO/FIXME
      run: |
        echo "## TODOs and FIXMEs found in code:" 
        grep -rn "TODO\|FIXME" --include="*.swift" VisualAssist/ || echo "None found ✓"
      continue-on-error: true

  accessibility-check:
    name: Accessibility Compliance
    runs-on: macos-14
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Check Accessibility Labels
      run: |
        echo "## Checking accessibility compliance..."
        
        # Count files with accessibility modifiers
        ACCESSIBLE=$(grep -rl "accessibilityLabel\|accessibilityHint\|accessibilityValue" --include="*.swift" VisualAssist/ | wc -l | tr -d ' ')
        VIEWS=$(find VisualAssist -name "*View.swift" | wc -l | tr -d ' ')
        
        echo "Files with accessibility modifiers: $ACCESSIBLE"
        echo "Total view files: $VIEWS"
        
        # Check for VoiceOver support
        VOICEOVER=$(grep -rl "VoiceOver\|UIAccessibility\|AXCustomContent" --include="*.swift" VisualAssist/ | wc -l | tr -d ' ')
        echo "Files with VoiceOver references: $VOICEOVER"
        
        # List views without accessibility labels (informational)
        echo ""
        echo "## Views to verify accessibility:"
        for file in $(find VisualAssist -name "*View.swift"); do
          if ! grep -q "accessibilityLabel" "$file"; then
            echo "  ⚠️  $file - no accessibilityLabel found"
          else
            echo "  ✓  $file"
          fi
        done
      continue-on-error: true

  documentation:
    name: Documentation Check
    runs-on: macos-14
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Check Documentation
      run: |
        echo "## Checking documentation coverage..."
        
        # Check for doc comments
        DOCUMENTED=$(grep -rl "/// " --include="*.swift" VisualAssist/ | wc -l | tr -d ' ')
        TOTAL=$(find VisualAssist -name "*.swift" | wc -l | tr -d ' ')
        
        echo "Files with documentation comments: $DOCUMENTED / $TOTAL"
        
        # Check for README
        if [ -f "README.md" ]; then
          echo "✓ README.md exists"
          WORDS=$(wc -w < README.md | tr -d ' ')
          echo "  Word count: $WORDS"
        else
          echo "✗ README.md missing"
          exit 1
        fi
        
        # Check for other docs
        for doc in CHANGELOG.md CONTRIBUTING.md LICENSE SECURITY.md; do
          if [ -f "$doc" ]; then
            echo "✓ $doc exists"
          else
            echo "⚠️  $doc missing"
          fi
        done

